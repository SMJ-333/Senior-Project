<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Ticket Management</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- âœ… EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        // Initialize EmailJS with your Public Key
        (function () {
            emailjs.init("-44BWtrRgLumgCqoN");
        })();
    </script>
    <style>
        :root {
            --primary-dark: #653025;
            --primary-light: #8d2e1d;
            --accent: #b08d57;
            --accent-light: #d4b483;
            --neutral-light: #f4f1e3;
            --neutral-dark: #4a3c2a;
            --text-dark: #3b2f23;
            --text-light: #7c6f57;
            --white: #fdfaf4;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
            --success: #48bb78;
            --danger: #f56565;
            --warning: #ecc94b;
            --info: #4299e1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background-color: var(--neutral-light);
        }

        h1,
        h2,
        h3 {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
        }

        .admin-header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-light) 100%);
            color: var(--white);
            padding: 1.5rem 2rem;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            color: var(--white);
            border: none;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: var(--transition);
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .header-title h1 {
            font-size: 1.8rem;
            margin-bottom: 0.2rem;
        }

        .header-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .view-btn {
            background: var(--accent);
            color: var(--white);
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .view-btn:hover {
            background: var(--accent-light);
            transform: translateY(-2px);
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .stat-icon.primary {
            background: linear-gradient(135deg, var(--primary-light), var(--primary-dark));
            color: var(--white);
        }

        .stat-icon.accent {
            background: linear-gradient(135deg, var(--accent), var(--accent-light));
            color: var(--primary-dark);
        }

        .stat-icon.success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: var(--white);
        }

        .stat-icon.warning {
            background: linear-gradient(135deg, #ecc94b, #d69e2e);
            color: var(--primary-dark);
        }

        .stat-info h3 {
            font-size: 2rem;
            color: var(--primary-dark);
            margin-bottom: 0.2rem;
        }

        .stat-info p {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .action-bar {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .search-box {
            flex: 1;
            max-width: 400px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.8rem 1rem 0.8rem 3rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        .filter-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .filter-btn {
            background: var(--neutral-light);
            color: var(--text-dark);
            border: 2px solid transparent;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .filter-btn:hover {
            background: #e2e8f0;
        }

        .filter-btn.active {
            background: var(--accent);
            color: var(--primary-dark);
            border-color: var(--accent);
        }

        .filter-select {
            background: var(--white);
            color: var(--text-dark);
            border: 2px solid #e2e8f0;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            font-family: 'Inter', sans-serif;
        }

        .filter-select:hover {
            border-color: var(--accent);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(176, 141, 87, 0.1);
        }

        .clear-btn {
            background: var(--accent);
            color: var(--white);
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .clear-btn:hover {
            background: #9a7835;
            transform: translateY(-2px);
        }

        .export-btn {
            background: #ffffff;
            color: var(--text-dark);
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .export-btn:hover {
            color: var(--info);
        }

        .tickets-table-container {
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .table-wrapper {
            max-height: 450px;
            overflow-y: auto;
            overflow-x: auto;
        }

        .table-wrapper::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: var(--neutral-light);
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 4px;
        }

        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 2px solid var(--neutral-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h2 {
            color: var(--primary-dark);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--neutral-light);
        }

        th {
            padding: 1rem 1.5rem;
            text-align: left;
            font-weight: 600;
            color: var(--primary-dark);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--neutral-light);
        }

        tbody tr {
            transition: var(--transition);
        }

        tbody tr:hover {
            background: var(--neutral-light);
        }

        .ticket-type-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-general {
            background: #dad5cd;
            color: #92400e;
        }

        .badge-event {
            background: #c2d3e1;
            color: #3730a3;
        }

        .status-badge {
            display: inline-block;
            padding: 0.3rem 0.7rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-confirmed {
            background: #d1fae5;
            color: #065f46;
        }

        .status-cancelled {
            background: #fee2e2;
            color: #991b1b;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-dark);
        }

        .btn-view:hover {
            background: var(--neutral-light);
            transform: scale(1.05);
        }

        .btn-status:hover {
            background: var(--neutral-light);
            transform: scale(1.05);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-content {
            background: var(--white);
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 2rem 2.5rem;
            border-bottom: 2px solid var(--neutral-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--neutral-light) 0%, var(--white) 100%);
        }

        .modal-header h2 {
            color: var(--primary-dark);
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-header h2::before {
            content: 'ðŸ“‹';
            font-size: 1.5rem;
        }

        .close-modal {
            background: var(--neutral-light);
            border: none;
            font-size: 1.5rem;
            color: var(--text-dark);
            cursor: pointer;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            background: var(--danger);
            color: var(--white);
        }

        .modal-body {
            padding: 2.5rem;
            background: var(--white);
        }

        .detail-section {
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid var(--neutral-light);
        }

        .detail-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .section-heading {
            font-size: 1.1rem;
            color: var(--primary-dark);
            margin-bottom: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-heading::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--accent);
            border-radius: 2px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.25rem;
        }

        .detail-item {
            padding: 1.25rem;
            background: linear-gradient(135deg, var(--neutral-light) 0%, #faf8f0 100%);
            border-radius: 12px;
            border-left: 4px solid var(--neutral-dark);
            transition: var(--transition);
        }

        .detail-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .detail-label {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .detail-label::before {
            content: 'â€¢';
            color: var(--accent);
            font-size: 1.2rem;
        }

        .detail-value {
            font-size: 1.15rem;
            color: var(--text-dark);
            font-weight: 600;
            word-wrap: break-word;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-light);
        }

        .empty-state .material-icons {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .price-cell {
            font-weight: 600;
            color: var(--primary-dark);
            font-size: 1.1rem;
        }

        .date-cell {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .analytics-section {
            margin-top: 5rem;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(430px, 1fr));
            gap: 2rem;
            max-width: 1400px;
        }

        .chart-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .chart-title {
            font-size: 1.3rem;
            color: var(--primary-dark);
            margin-bottom: 1rem;
            font-weight: 600;
            font-family: 'Playfair Display', serif;
        }

        .chart-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            justify-content: center;
        }

        .chart-btn {
            background: var(--neutral-light);
            color: var(--text-dark);
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .chart-btn:hover {
            background: #e2e8f0;
        }

        .chart-btn.active {
            background: var(--accent);
            color: var(--primary-dark);
        }

        .revenue-chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .revenue-chart-container {
            position: relative;
            height: 100%;
            width: 100%;
        }

        .chart-card canvas {
            max-height: 300px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* ===== CUSTOM ALERT SYSTEM ===== */
        .custom-alert-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease;
        }

        .custom-alert-overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideInAlert {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .custom-alert-box {
            background: var(--white);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            padding: 0;
            animation: slideInAlert 0.3s ease;
            overflow: hidden;
        }

        .custom-alert-header {
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border-bottom: 2px solid var(--neutral-light);
        }

        .custom-alert-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            flex-shrink: 0;
        }

        .custom-alert-icon.success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .custom-alert-icon.warning {
            background: linear-gradient(135deg, #ecc94b, #d69e2e);
            color: white;
        }

        .custom-alert-icon.danger {
            background: linear-gradient(135deg, #f56565, #e53e3e);
            color: white;
        }

        .custom-alert-icon.info {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
        }

        .custom-alert-header-text {
            flex: 1;
        }

        .custom-alert-header-text h3 {
            font-size: 1.3rem;
            color: var(--primary-dark);
            margin: 0;
        }

        .custom-alert-header-text p {
            font-size: 0.85rem;
            color: var(--text-light);
            margin: 0.2rem 0 0 0;
        }

        .custom-alert-body {
            padding: 1.5rem;
            color: var(--text-dark);
            line-height: 1.6;
        }

        .custom-alert-body p {
            margin: 0 0 0.8rem 0;
        }

        .custom-alert-body p:last-child {
            margin-bottom: 0;
        }

        .custom-alert-body strong {
            color: var(--primary-dark);
        }

        .custom-alert-body ul {
            margin: 0.5rem 0 0 1.2rem;
            padding: 0;
        }

        .custom-alert-body li {
            margin-bottom: 0.3rem;
        }

        .custom-alert-highlight {
            background: rgba(245, 101, 101, 0.1);
            border-left: 4px solid var(--danger);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .custom-alert-highlight.info {
            background: rgba(66, 153, 225, 0.1);
            border-left-color: #4299e1;
        }

        .custom-alert-actions {
            padding: 1rem 1.5rem 1.5rem 1.5rem;
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .custom-alert-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-family: 'Inter', sans-serif;
        }

        .custom-alert-btn.primary {
            background: var(--primary-dark);
            color: var(--white);
        }

        .custom-alert-btn.primary:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .custom-alert-btn.danger {
            background: var(--danger);
            color: var(--white);
        }

        .custom-alert-btn.danger:hover {
            background: #e53e3e;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 101, 101, 0.3);
        }

        .custom-alert-btn.secondary {
            background: var(--neutral-light);
            color: var(--text-dark);
            border: 2px solid #e2e8f0;
        }

        .custom-alert-btn.secondary:hover {
            background: #e2e8f0;
        }

        .custom-alert-btn.success {
            background: var(--success);
            color: var(--white);
        }

        .custom-alert-btn.success:hover {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }

        @media (max-width: 768px) {
            .action-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                max-width: none;
            }

            .filter-controls {
                flex-wrap: wrap;
            }

            table {
                font-size: 0.85rem;
            }

            th,
            td {
                padding: 0.8rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            .custom-alert-box {
                width: 95%;
                max-width: none;
            }

            .custom-alert-header {
                padding: 1.2rem;
            }

            .custom-alert-icon {
                width: 45px;
                height: 45px;
                font-size: 1.5rem;
            }

            .custom-alert-header-text h3 {
                font-size: 1.1rem;
            }

            .custom-alert-body {
                padding: 1.2rem;
            }

            .custom-alert-actions {
                padding: 1rem 1.2rem 1.2rem 1.2rem;
                flex-direction: column;
            }

            .custom-alert-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <header class="admin-header">
        <div class="header-left">
            <button class="back-btn" onclick="window.location.href='AdminDashboard.html'">
                <span class="material-icons">arrow_back</span>
            </button>
            <div class="header-title">
                <h1>Ticket Sales Management</h1>
                <div class="header-subtitle">View and manage all ticket purchases</div>
            </div>
        </div>
        <div class="header-actions">
            <a href="Ticketing.html" target="_blank" class="view-btn">
                <span class="material-icons">open_in_new</span>
                View Tickets Page
            </a>
        </div>
    </header>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon primary">
                    <span class="material-icons">payments</span>
                </div>
                <div class="stat-info">
                    <h3 id="total-revenue">$0.00</h3>
                    <p>Total Revenue</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon accent">
                    <span class="material-icons">confirmation_number</span>
                </div>
                <div class="stat-info">
                    <h3 id="total-bookings">0</h3>
                    <p>Total Bookings</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon success">
                    <span class="material-icons">people</span>
                </div>
                <div class="stat-info">
                    <h3 id="total-visitors">0</h3>
                    <p>Total Visitors</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon warning">
                    <span class="material-icons">event</span>
                </div>
                <div class="stat-info">
                    <h3 id="event-bookings">0</h3>
                    <p>Event Bookings</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon danger">
                    <span class="material-icons">money_off</span>
                </div>
                <div class="stat-info">
                    <h3 id="pending-refunds">0</h3>
                    <p>Pending Refunds</p>
                </div>
            </div>
        </div>

        <div class="action-bar">
            <div class="search-box">
                <span class="material-icons search-icon">search</span>
                <input type="text" class="search-input" id="search-input"
                    placeholder="Search by name, email, or booking ID...">
            </div>
            <div class="filter-controls">
                <select class="filter-select" id="type-filter">
                    <option value="all">All Types</option>
                    <option value="general">General Visit</option>
                    <option value="event">Event</option>
                </select>
                <select class="filter-select" id="status-filter">
                    <option value="all">All Status</option>
                    <option value="confirmed">Confirmed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
                <button class="clear-btn" id="clear-filters-btn">
                    <span class="material-icons">clear</span>
                    Clear Filters
                </button>
            </div>
        </div>

        <div class="tickets-table-container">
            <div class="table-header">
                <h2>All Bookings</h2>
                <button class="export-btn" id="export-btn">
                    <span class="material-icons">download</span>
                    Export Data
                </button>
            </div>

            <div id="loading" class="loading">
                <span class="material-icons" style="font-size: 3rem; animation: spin 1s linear infinite;">refresh</span>
                <p>Loading bookings...</p>
            </div>

            <div id="empty-state" class="empty-state" style="display: none;">
                <span class="material-icons">confirmation_number</span>
                <h3>No Bookings Yet</h3>
                <p>Ticket purchases will appear here</p>
            </div>

            <div class="table-wrapper">
                <table id="tickets-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th>User ID</th>
                            <th>Type</th>
                            <th>Ticket Price</th>
                            <th>Visit Date</th>
                            <th>Visitors</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tickets-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Refunds Management Table -->
        <div class="action-bar">
            <h2 style="font-family: 'Playfair Display', serif; color: var(--primary-dark); margin: 0;">
                <span class="material-icons" style="vertical-align: middle; margin-right: 0.5rem;">money_off</span>
                Refunds Management
            </h2>
            <div class="filter-controls">
                <select class="filter-select" id="refund-status-filter">
                    <option value="all">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="processing">Processing</option>
                    <option value="completed">Completed</option>
                    <option value="failed">Failed</option>
                </select>
            </div>
        </div>

        <div class="tickets-table-container">
            <div class="table-header">
                <h2>Refund Requests</h2>
                <button class="export-btn" id="export-refunds-btn">
                    <span class="material-icons">download</span>
                    Export Refunds
                </button>
            </div>

            <div id="refunds-loading" class="loading" style="display: none;">
                <span class="material-icons" style="font-size: 3rem; animation: spin 1s linear infinite;">refresh</span>
                <p>Loading refunds...</p>
            </div>

            <div id="refunds-empty-state" class="empty-state" style="display: none;">
                <span class="material-icons">money_off</span>
                <h3>No Refund Requests</h3>
                <p>Cancelled bookings with refunds will appear here</p>
            </div>

            <div class="table-wrapper">
                <table id="refunds-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Booking ID</th>
                            <th>Customer</th>
                            <th>Event/Type</th>
                            <th>Cancelled Date</th>
                            <th>Refund Amount</th>
                            <th>Payment Method</th>
                            <th>Reason</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="refunds-tbody">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Section -->
        <div class="analytics-section">
            <h2
                style="font-family: 'Playfair Display', serif; color: var(--primary-dark); margin-bottom: 2rem; margin-left: 1rem;">
                Booking
                Analytics</h2>

            <div class="charts-grid">
                <!-- Revenue Chart -->
                <div class="chart-card">
                    <h3 class="chart-title">Revenue Overview</h3>
                    <div class="chart-controls">
                        <button class="chart-btn active" data-period="day"
                            onclick="changeRevenuePeriod('day')">Daily</button>
                        <button class="chart-btn" data-period="month"
                            onclick="changeRevenuePeriod('month')">Monthly</button>
                        <button class="chart-btn" data-period="year"
                            onclick="changeRevenuePeriod('year')">Yearly</button>
                    </div>
                    <div class="revenue-chart-wrapper">
                        <div class="revenue-chart-container">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Ticket Types Chart -->
                <div class="chart-card">
                    <h3 class="chart-title">Ticket Types Distribution</h3>
                    <canvas id="ticketTypesChart"></canvas>
                </div>

                <!-- Status Chart -->
                <div class="chart-card">
                    <h3 class="chart-title">Booking Status</h3>
                    <canvas id="statusChart"></canvas>
                </div>

                <!-- Visitors Chart -->
                <div class="chart-card">
                    <h3 class="chart-title">Visitor Types Breakdown</h3>
                    <canvas id="visitorsChart"></canvas>
                </div>

                <!-- Event Tickets Chart -->
                <div class="chart-card">
                    <h3 class="chart-title">Tickets Sold by Event</h3>
                    <canvas id="eventTicketsChart"></canvas>
                </div>

                <!-- Busiest Times Chart -->
                <div class="chart-card">
                    <h3 class="chart-title">Busiest Visit Times</h3>
                    <canvas id="busiestTimesChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- View Details Modal -->
    <div class="modal" id="view-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Booking Details</h2>
                <button class="close-modal" id="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Customer Information Group -->
                <div class="detail-section">
                    <h3 class="section-heading">Customer Information</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">User ID</div>
                            <div class="detail-value" id="detail-user-id">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Customer Name</div>
                            <div class="detail-value" id="detail-customer-name">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Email</div>
                            <div class="detail-value" id="detail-email">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Phone</div>
                            <div class="detail-value" id="detail-phone">-</div>
                        </div>
                    </div>
                </div>

                <!-- Booking Information Group -->
                <div class="detail-section">
                    <h3 class="section-heading">Booking Information</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Booking ID</div>
                            <div class="detail-value" id="detail-booking-id">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Ticket Type</div>
                            <div class="detail-value" id="detail-ticket-type">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Event Name</div>
                            <div class="detail-value" id="detail-event-name">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Ticket Price</div>
                            <div class="detail-value" id="detail-ticket-price">-</div>
                        </div>
                    </div>
                </div>

                <!-- Visit Details Group -->
                <div class="detail-section">
                    <h3 class="section-heading">Visit Details</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Visit Date</div>
                            <div class="detail-value" id="detail-visit-date">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Visit Time</div>
                            <div class="detail-value" id="detail-visit-time">-</div>
                        </div>
                    </div>
                </div>

                <!-- Visitors Breakdown Group -->
                <div class="detail-section">
                    <h3 class="section-heading">Visitors Breakdown</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Adults</div>
                            <div class="detail-value" id="detail-adults">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Seniors</div>
                            <div class="detail-value" id="detail-seniors">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Children</div>
                            <div class="detail-value" id="detail-children">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Total Visitors</div>
                            <div class="detail-value" id="detail-total-visitors">-</div>
                        </div>
                    </div>
                </div>

                <!-- Payment Information Group -->
                <div class="detail-section">
                    <h3 class="section-heading">Payment Information</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Total Price</div>
                            <div class="detail-value" id="detail-total-price">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Payment Method</div>
                            <div class="detail-value" id="detail-payment-method">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Purchase Date</div>
                            <div class="detail-value" id="detail-purchase-date">-</div>
                        </div>
                    </div>
                </div>

                <!-- Status Group -->
                <div class="detail-section">
                    <h3 class="section-heading">Status</h3>
                    <div class="detail-grid" style="grid-template-columns: 1fr;">
                        <div class="detail-item">
                            <div class="detail-label">Booking Status</div>
                            <div class="detail-value" id="detail-status">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Alert System -->
    <div class="custom-alert-overlay" id="customAlertOverlay">
        <div class="custom-alert-box">
            <div class="custom-alert-header">
                <div class="custom-alert-icon" id="customAlertIcon">
                    <span class="material-icons" id="customAlertIconSymbol">check_circle</span>
                </div>
                <div class="custom-alert-header-text">
                    <h3 id="customAlertTitle">Title</h3>
                    <p id="customAlertSubtitle"></p>
                </div>
            </div>
            <div class="custom-alert-body" id="customAlertBody">
                Message content
            </div>
            <div class="custom-alert-actions" id="customAlertActions">
                <!-- Buttons will be added dynamically -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script type="module">
        import { auth, db } from './firebase-config.js';
        import { collection, getDocs, deleteDoc, doc, query, orderBy, onSnapshot, updateDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ===== EMAILJS EMAIL NOTIFICATION SYSTEM =====
        const EMAILJS_CONFIG = {
            serviceId: 'service_mjy8g9h',
            templateIdManual: 'template_887d9rd',  // Manual cancellation (general + event)
            templateIdEvent: 'template_30kx56m',    // Event cancelled by museum
            publicKey: '-44BWtrRgLumgCqoN'
        };

        /**
         * Send manual cancellation email (customer requested)
         * Works for BOTH general visits AND event tickets
         */
        async function sendManualCancellationEmail(recipientEmail, recipientName, bookingId, ticketInfo, visitDate, refundAmount) {
            // Format date without time
            const formattedDate = new Date(visitDate).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const templateParams = {
                recipientEmail: recipientEmail,
                recipientName: recipientName,
                bookingId: bookingId,
                ticketInfo: ticketInfo,  // "General Museum Visit" or "Art Workshop"
                visitDate: formattedDate,
                refundAmount: refundAmount
            };

            try {
                console.log(`ðŸ“§ Sending manual cancellation email to: ${recipientEmail}`);

                const response = await emailjs.send(
                    EMAILJS_CONFIG.serviceId,
                    EMAILJS_CONFIG.templateIdManual,
                    templateParams
                );

                console.log(`âœ… Manual cancellation email sent to: ${recipientEmail}`);
                return true;
            } catch (error) {
                console.error(`âŒ Failed to send email to: ${recipientEmail}`, error);
                return false;
            }
        }

        async function testTicketingEmail(testEmail, testType = 'general') {
            console.log('ðŸ§ª Testing manual cancellation email...');

            let ticketInfo, visitDate;

            if (testType === 'general') {
                ticketInfo = 'General Museum Visit';
                visitDate = '2025-01-15';
            } else {
                ticketInfo = 'Art Workshop';
                visitDate = '2025-01-20';
            }

            const success = await sendManualCancellationEmail(
                testEmail,
                'Test Customer',
                'TEST-12345',
                ticketInfo,
                visitDate,
                '15.00'
            );

            console.log(success ? 'âœ… Test passed!' : 'âŒ Test failed!');
            return success;
        }

        window.testTicketingEmail = testTicketingEmail;

        // ===== CUSTOM ALERT SYSTEM =====
        function showCustomAlert(options) {
            return new Promise((resolve) => {
                const overlay = document.getElementById('customAlertOverlay');
                const icon = document.getElementById('customAlertIcon');
                const iconSymbol = document.getElementById('customAlertIconSymbol');
                const title = document.getElementById('customAlertTitle');
                const subtitle = document.getElementById('customAlertSubtitle');
                const body = document.getElementById('customAlertBody');
                const actions = document.getElementById('customAlertActions');

                icon.className = 'custom-alert-icon ' + (options.type || 'info');
                iconSymbol.textContent = options.icon || 'info';
                title.textContent = options.title || 'Notification';
                subtitle.textContent = options.subtitle || '';
                body.innerHTML = options.body || '';

                actions.innerHTML = '';
                if (options.buttons) {
                    options.buttons.forEach(btn => {
                        const button = document.createElement('button');
                        button.className = 'custom-alert-btn ' + (btn.type || 'primary');
                        button.innerHTML = btn.icon ?
                            `<span class="material-icons" style="font-size: 1rem;">${btn.icon}</span> ${btn.text}` :
                            btn.text;
                        button.onclick = () => {
                            overlay.classList.remove('active');
                            resolve(btn.value);
                        };
                        actions.appendChild(button);
                    });
                } else {
                    const button = document.createElement('button');
                    button.className = 'custom-alert-btn primary';
                    button.textContent = 'OK';
                    button.onclick = () => {
                        overlay.classList.remove('active');
                        resolve(true);
                    };
                    actions.appendChild(button);
                }

                overlay.classList.add('active');

                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        overlay.classList.remove('active');
                        resolve(false);
                    }
                };
            });
        }

        function showSuccessAlert(title, message) {
            return showCustomAlert({
                type: 'success',
                icon: 'check_circle',
                title: title,
                subtitle: 'Operation completed successfully',
                body: `<p>${message}</p>`,
                buttons: [
                    { text: 'Done', type: 'success', value: true, icon: 'check' }
                ]
            });
        }

        function showErrorAlert(title, message) {
            return showCustomAlert({
                type: 'danger',
                icon: 'error',
                title: title,
                subtitle: 'An error occurred',
                body: `<p>${message}</p>`,
                buttons: [
                    { text: 'Close', type: 'secondary', value: true }
                ]
            });
        }

        function showConfirmAlert(title, message) {
            return showCustomAlert({
                type: 'warning',
                icon: 'help_outline',
                title: title,
                subtitle: 'Please confirm your action',
                body: `<p>${message}</p>`,
                buttons: [
                    { text: 'Cancel', type: 'secondary', value: false },
                    { text: 'Confirm', type: 'primary', value: true, icon: 'check' }
                ]
            });
        }

        async function logActivity(type, action, targetTitle, metadata = {}) {
            try {
                const user = auth.currentUser;
                await addDoc(collection(db, "ActivityLog"), {
                    type: type,
                    action: action,
                    targetTitle: targetTitle,
                    userEmail: user?.email || 'Admin',
                    timestamp: serverTimestamp(),
                    metadata: metadata
                });
                console.log('âœ“ Activity logged:', type, action, targetTitle);
            } catch (error) {
                console.error('âœ— Error logging activity:', error);
            }
        }

        let allBookings = [];
        let filteredBookings = [];
        let currentUser = null;
        let currentTypeFilter = 'all';
        let currentStatusFilter = 'all';

        const viewModal = document.getElementById('view-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const ticketsTbody = document.getElementById('tickets-tbody');
        const ticketsTable = document.getElementById('tickets-table');
        const loading = document.getElementById('loading');
        const emptyState = document.getElementById('empty-state');
        const searchInput = document.getElementById('search-input');
        const exportBtn = document.getElementById('export-btn');
        const typeFilter = document.getElementById('type-filter');
        const statusFilter = document.getElementById('status-filter');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (!user) {
                window.location.href = 'Login.html';
            }
        });

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            let date;
            if (timestamp.toDate) {
                date = timestamp.toDate();
            } else {
                date = new Date(timestamp);
            }
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function updateStats() {
            const totalRevenue = allBookings.reduce((sum, booking) => sum + (booking.totalPrice || 0), 0);
            const totalBookings = allBookings.length;
            const totalVisitors = allBookings.reduce((sum, booking) => sum + (booking.totalVisitors || 0), 0);
            const eventBookings = allBookings.filter(b => b.ticketType === 'event').length;

            document.getElementById('total-revenue').textContent = `${totalRevenue.toFixed(2)}`;
            document.getElementById('total-bookings').textContent = totalBookings;
            document.getElementById('total-visitors').textContent = totalVisitors;
            document.getElementById('event-bookings').textContent = eventBookings;
        }

        function renderBookingsTable(bookingsList) {
            loading.style.display = 'none';
            ticketsTbody.innerHTML = '';

            if (bookingsList.length === 0) {
                ticketsTable.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            ticketsTable.style.display = 'table';
            emptyState.style.display = 'none';

            bookingsList.forEach((booking, index) => {
                const badgeClass = booking.ticketType === 'event' ? 'badge-event' : 'badge-general';
                const typeText = booking.ticketType === 'event' ? 'Event' : 'General Visit';

                const userIdDisplay = booking.userId === 'guest'
                    ? '<span style="color: #969ca7; padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.85rem; font-weight: 600;">Guest</span>'
                    : `<code style="background: var(--neutral-light); padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.85rem;">${booking.userId.substring(0, 8)}...</code>`;

                let ticketPriceDisplay;
                if (booking.ticketType === 'general') {
                    ticketPriceDisplay = '<div class="price-cell" style="font-size: 0.95rem;">$15.00</div>';
                } else if (booking.eventPrice) {
                    ticketPriceDisplay = `<div class="price-cell" style="font-size: 0.95rem;">${booking.eventPrice.toFixed(2)}</div>`;
                } else {
                    ticketPriceDisplay = '<span style="color: var(--text-light); font-size: 0.85rem;">N/A</span>';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="font-weight: 600;">${booking.userName || 'N/A'}</div>
                        <div style="font-size: 0.85rem; color: var(--text-light);">${booking.userEmail || 'N/A'}</div>
                    </td>
                    <td>${userIdDisplay}</td>
                    <td><span class="ticket-type-badge ${badgeClass}">${typeText}</span></td>
                    <td>${ticketPriceDisplay}</td>
                    <td>
                        <div class="date-cell">${formatDate(booking.visitDate)}</div>
                        <div style="font-size: 0.8rem; color: var(--text-light);">${booking.visitTime || 'N/A'}</div>
                    </td>
                    <td>
                        <div style="font-weight: 600;">${booking.totalVisitors || 0} visitors</div>
                        <div style="font-size: 0.8rem; color: var(--text-light);">
                            A: ${booking.visitors?.adults?.count || 0} | 
                            S: ${booking.visitors?.seniors?.count || 0} | 
                            C: ${booking.visitors?.children?.count || 0}
                        </div>
                    </td>
                    <td><div class="price-cell">${(booking.totalPrice || 0).toFixed(2)}</div></td>
                    <td><span class="status-badge status-${booking.status || 'confirmed'}">${(booking.status || 'confirmed').charAt(0).toUpperCase() + (booking.status || 'confirmed').slice(1)}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon btn-view" data-id="${booking.id}" title="View Details">
                                <span class="material-icons" style="font-size: 1.2rem;">edit</span>
                            </button>
                            <button class="btn-icon btn-status" data-id="${booking.id}" data-status="${booking.status || 'confirmed'}" title="Change Status">
                                <span class="material-icons" style="font-size: 1.2rem;">delete</span>
                            </button>
                        </div>
                    </td>
                `;
                ticketsTbody.appendChild(row);
            });

            document.querySelectorAll('.btn-view').forEach(btn => {
                btn.addEventListener('click', handleView);
            });

            document.querySelectorAll('.btn-status').forEach(btn => {
                btn.addEventListener('click', handleStatusChange);
            });
        }

        function loadBookings() {
            try {
                const q = query(collection(db, "Ticketing"), orderBy("purchaseDate", "desc"));

                onSnapshot(q, (snapshot) => {
                    allBookings = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    console.log('âœ… Loaded bookings:', allBookings);
                    applyFilters();
                    updateStats();
                    initializeCharts();

                    allRefunds = allBookings.filter(b =>
                        b.status === 'cancelled' &&
                        b.refundStatus &&
                        b.refundAmount > 0
                    );

                    applyRefundFilters();
                }, (error) => {
                    console.error("Error listening to bookings:", error);
                    loading.innerHTML = '<p style="color: var(--danger);">Error loading bookings. Please refresh the page.</p>';
                });

            } catch (error) {
                console.error("Error loading bookings:", error);
                loading.innerHTML = '<p style="color: var(--danger);">Error loading bookings. Please refresh the page.</p>';
            }
        }

        function applyFilters() {
            let bookings = [...allBookings];

            if (currentTypeFilter === 'general') {
                bookings = bookings.filter(b => b.ticketType === 'general');
            } else if (currentTypeFilter === 'event') {
                bookings = bookings.filter(b => b.ticketType === 'event');
            }

            if (currentStatusFilter === 'confirmed') {
                bookings = bookings.filter(b => b.status === 'confirmed');
            } else if (currentStatusFilter === 'cancelled') {
                bookings = bookings.filter(b => b.status === 'cancelled');
            }

            const searchTerm = searchInput.value.toLowerCase().trim();
            if (searchTerm) {
                bookings = bookings.filter(booking =>
                    booking.userName?.toLowerCase().includes(searchTerm) ||
                    booking.userEmail?.toLowerCase().includes(searchTerm) ||
                    booking.id.toLowerCase().includes(searchTerm) ||
                    booking.eventName?.toLowerCase().includes(searchTerm) ||
                    booking.userId?.toLowerCase().includes(searchTerm)
                );
            }

            filteredBookings = bookings;
            renderBookingsTable(filteredBookings);
        }

        function handleView(e) {
            const bookingId = e.currentTarget.getAttribute('data-id');
            const booking = allBookings.find(b => b.id === bookingId);

            if (!booking) return;

            document.getElementById('detail-booking-id').textContent = booking.id;

            const userIdElement = document.getElementById('detail-user-id');
            if (booking.userId === 'guest') {
                userIdElement.innerHTML = '<span style="background: #e2e8f0; color: #4a5568; padding: 0.4rem 0.8rem; border-radius: 8px; font-size: 0.95rem; font-weight: 600;">Guest User</span>';
            } else {
                userIdElement.textContent = booking.userId || 'N/A';
            }

            document.getElementById('detail-customer-name').textContent = booking.userName || 'N/A';
            document.getElementById('detail-email').textContent = booking.userEmail || 'N/A';
            document.getElementById('detail-phone').textContent = booking.userPhone || 'N/A';
            document.getElementById('detail-ticket-type').textContent =
                booking.ticketType === 'event' ? 'Event Ticket' : 'General Visit';
            document.getElementById('detail-event-name').textContent = booking.eventName || 'N/A';

            if (booking.ticketType === 'general') {
                document.getElementById('detail-ticket-price').textContent = '$15.00';
            } else if (booking.eventPrice) {
                document.getElementById('detail-ticket-price').textContent = `${booking.eventPrice.toFixed(2)}`;
            } else {
                document.getElementById('detail-ticket-price').textContent = 'N/A';
            }

            document.getElementById('detail-visit-date').textContent = formatDate(booking.visitDate);
            document.getElementById('detail-visit-time').textContent = booking.visitTime || 'N/A';
            document.getElementById('detail-adults').textContent =
                `${booking.visitors?.adults?.count || 0} (Total: $${(booking.visitors?.adults?.total || 0).toFixed(2)})`;
            document.getElementById('detail-seniors').textContent =
                `${booking.visitors?.seniors?.count || 0} (Total: $${(booking.visitors?.seniors?.total || 0).toFixed(2)})`;
            document.getElementById('detail-children').textContent =
                `${booking.visitors?.children?.count || 0} (Free)`;
            document.getElementById('detail-total-visitors').textContent = booking.totalVisitors || 0;
            document.getElementById('detail-total-price').textContent = `$${(booking.totalPrice || 0).toFixed(2)}`;
            document.getElementById('detail-payment-method').textContent =
                booking.paymentDetails?.method ? booking.paymentDetails.method.charAt(0).toUpperCase() + booking.paymentDetails.method.slice(1) : 'N/A';
            document.getElementById('detail-purchase-date').textContent = formatTimestamp(booking.purchaseDate);

            const statusElement = document.getElementById('detail-status');
            const status = booking.status || 'confirmed';
            const statusText = status.charAt(0).toUpperCase() + status.slice(1);
            statusElement.innerHTML = `<span class="status-badge status-${status}" style="font-size: 0.9rem; padding: 0.5rem 1rem;">${statusText}</span>`;

            viewModal.classList.add('active');
        }

        function closeModalFn() {
            viewModal.classList.remove('active');
        }

        async function handleStatusChange(e) {
            const bookingId = e.currentTarget.getAttribute('data-id');
            const currentStatus = e.currentTarget.getAttribute('data-status');
            const booking = allBookings.find(b => b.id === bookingId);

            if (!booking) return;

            // Prevent re-confirming cancelled tickets
            if (currentStatus === 'cancelled') {
                await showCustomAlert({
                    type: 'danger',
                    icon: 'block',
                    title: 'Cannot Change Status',
                    subtitle: 'Cancelled bookings cannot be reactivated',
                    body: `
                <div class="custom-alert-highlight">
                    <p><strong>âš ï¸ This booking has been cancelled and cannot be confirmed again.</strong></p>
                    <p style="margin-top: 0.5rem;">Once a ticket is cancelled, the status is permanent. If the customer needs a new booking, they must purchase a new ticket.</p>
                </div>
                <div style="margin-top: 1rem;">
                    <strong>Booking Details:</strong>
                    <ul style="margin: 0.5rem 0 0 1.2rem;">
                        <li>Customer: ${booking.userName}</li>
                        <li>Type: ${booking.ticketType === 'event' ? booking.eventName : 'General Visit'}</li>
                        <li>Visit Date: ${formatDate(booking.visitDate)}</li>
                    </ul>
                </div>
            `,
                    buttons: [
                        { text: 'Close', type: 'secondary', value: true }
                    ]
                });
                return;
            }

            // Only allow confirmed â†’ cancelled (one-way)
            const newStatus = 'cancelled';
            const newStatusText = 'Cancelled';
            const currentStatusText = 'Confirmed';

            const confirmed = await showCustomAlert({
                type: 'warning',
                icon: 'cancel',
                title: 'Cancel This Booking?',
                subtitle: 'This action cannot be undone',
                body: `
        <p><strong>${booking.userName}</strong> â€¢ ${booking.ticketType === 'event' ? booking.eventName : 'General Visit'}</p>
        <p style="color: var(--text-light); font-size: 0.9rem;">Visit: ${formatDate(booking.visitDate)} â€¢ Total: $${(booking.totalPrice || 0).toFixed(2)}</p>
        <div class="custom-alert-highlight" style="margin-top: 1rem;">
            <strong>âš ï¸ Warning:</strong> Customer will be notified and booking cannot be restored.
        </div>
    `,
                buttons: [
                    { text: 'Keep Booking', type: 'secondary', value: false },
                    { text: 'Cancel Booking', type: 'danger', value: true, icon: 'cancel' }
                ]
            });

            if (!confirmed) return;

            try {
                // Update booking status in Firestore
                await updateDoc(doc(db, "Ticketing", bookingId), {
                    status: newStatus,
                    cancelledAt: serverTimestamp(),
                    cancelledBy: 'admin',
                    refundStatus: 'pending',
                    refundAmount: booking.totalPrice,
                    cancellationReason: 'admin_manual'
                });

                // SEND EMAIL NOTIFICATION (for both members AND guests)
                let emailSent = false;
                if (booking.userEmail) {
                    if (booking.ticketType === 'general') {
                        // General visit cancellation
                        emailSent = await sendManualCancellationEmail(
                            booking.userEmail,
                            booking.userName || 'Valued Customer',
                            bookingId,
                            'General Museum Visit',  // ticketInfo
                            booking.visitDate,
                            (booking.totalPrice || 0).toFixed(2)
                        );
                    } else if (booking.ticketType === 'event') {
                        // Event ticket cancellation (customer requested, NOT event cancelled)
                        emailSent = await sendManualCancellationEmail(
                            booking.userEmail,
                            booking.userName || 'Valued Customer',
                            bookingId,
                            booking.eventName || 'Event Ticket',  // ticketInfo
                            booking.visitDate,
                            (booking.totalPrice || 0).toFixed(2)
                        );
                    }

                    if (emailSent) {
                        console.log(`âœ… Cancellation email sent to: ${booking.userEmail}`);
                    } else {
                        console.log(`âš ï¸ Failed to send email to: ${booking.userEmail}`);
                    }
                }

                // Send notification to user (if not guest)
                if (booking.userId && booking.userId !== 'guest') {
                    try {
                        await sendTicketCancellationNotification(booking.userId, {
                            bookingId: bookingId,
                            visitInfo: booking.ticketType === 'event' ? booking.eventName : 'General Museum Visit',
                            visitDate: formatDate(booking.visitDate),
                            visitTime: booking.visitTime || 'Event Time',
                            totalAmount: (booking.totalPrice || 0).toFixed(2),
                            customerName: booking.userName,
                            customerEmail: booking.userEmail,
                            cancellationType: 'admin', // or 'event' if event was cancelled
                            reason: 'This booking has been cancelled by museum administration.'
                        });
                        console.log('âœ… Cancellation notification sent to user:', booking.userId);
                    } catch (notifError) {
                        console.error('âš ï¸ Failed to send notification:', notifError);
                        // Continue even if notification fails
                    }
                }

                // Log activity
                const targetTitle = `${booking.userName || 'Customer'} - ${booking.ticketType === 'event' ? booking.eventName : 'General Visit'}`;
                await logActivity('ticket', 'cancelled', targetTitle, {
                    bookingId: bookingId,
                    changes: `status from ${currentStatusText} to ${newStatusText}`,
                    ticketType: booking.ticketType,
                    visitDate: booking.visitDate,
                    totalPrice: booking.totalPrice,
                    customerEmail: booking.userEmail,
                    cancelledBy: 'admin',
                    emailSent: emailSent,  // â† Track if email was sent
                    notificationSent: booking.userId !== 'guest'
                });

                // Show success message
                await showSuccessAlert(
                    'Booking Cancelled',
                    `
                    <p>The booking has been successfully cancelled.</p>
                    ${emailSent ?
                        '<p style="margin-top: 0.5rem;"><strong>âœ“</strong> Customer has been notified via email.</p>' :
                        '<p style="margin-top: 0.5rem; color: var(--text-light);">Email notification could not be sent.</p>'
                    }
                    ${booking.userId !== 'guest' ?
                        '<p style="font-size: 0.9rem; color: var(--text-light);">In-app notification also sent to member.</p>' :
                        ''
                    }
                    `
                );

            } catch (error) {
                console.error("âŒ Error updating booking status:", error);
                await showErrorAlert(
                    'Failed to Cancel Booking',
                    `An error occurred: ${error.message}`
                );
            }
        }

        async function sendTicketCancellationNotification(userId, details) {
            try {
                await addDoc(collection(db, "Notifications"), {
                    userId: userId,
                    type: 'ticket_cancelled',
                    title: 'âŒ Booking Cancelled',
                    message: `Your booking for ${details.visitInfo} on ${details.visitDate} has been cancelled.`,
                    read: false,
                    timestamp: serverTimestamp(),
                    data: {
                        bookingId: details.bookingId,
                        visitInfo: details.visitInfo,
                        visitDate: details.visitDate,
                        visitTime: details.visitTime,
                        totalAmount: details.totalAmount,
                        cancellationType: details.cancellationType || 'admin',
                        reason: details.reason || 'This booking has been cancelled.',
                        refundInfo: 'Please contact support for refund information.'
                    }
                });

                console.log('âœ… Cancellation notification created for user:', userId);
                return true;

            } catch (error) {
                console.error('âŒ Error sending cancellation notification:', error);
                throw error;
            }
        }

        function handleSearch() {
            applyFilters();
        }

        async function exportToCSV() {
            if (allBookings.length === 0) {
                await showErrorAlert('No Data to Export', 'There are no bookings to export.');
                return;
            }

            const headers = ['Booking ID', 'User ID', 'Customer Name', 'Email', 'Phone', 'Type', 'Event Name', 'Ticket Price', 'Visit Date', 'Visit Time', 'Adults', 'Seniors', 'Children', 'Total Visitors', 'Total Price', 'Payment Method', 'Status', 'Purchase Date'];

            const rows = allBookings.map(booking => {
                let ticketPrice;
                if (booking.ticketType === 'general') {
                    ticketPrice = '15.00';
                } else if (booking.eventPrice) {
                    ticketPrice = booking.eventPrice.toFixed(2);
                } else {
                    ticketPrice = 'N/A';
                }

                return [
                    booking.id,
                    booking.userId || 'N/A',
                    booking.userName || 'N/A',
                    booking.userEmail || 'N/A',
                    booking.userPhone || 'N/A',
                    booking.ticketType || 'general',
                    booking.eventName || 'N/A',
                    ticketPrice,
                    booking.visitDate || 'N/A',
                    booking.visitTime || 'N/A',
                    booking.visitors?.adults?.count || 0,
                    booking.visitors?.seniors?.count || 0,
                    booking.visitors?.children?.count || 0,
                    booking.totalVisitors || 0,
                    booking.totalPrice || 0,
                    booking.paymentDetails?.method || 'N/A',
                    booking.status || 'confirmed',
                    formatTimestamp(booking.purchaseDate)
                ];
            });

            let csvContent = headers.join(',') + '\n';
            rows.forEach(row => {
                csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', `ticket_sales_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            await showSuccessAlert(
                'Export Successful',
                `CSV file with ${allBookings.length} bookings has been downloaded.`
            );
        }

        closeModalBtn.addEventListener('click', closeModalFn);
        searchInput.addEventListener('input', handleSearch);
        exportBtn.addEventListener('click', exportToCSV);

        typeFilter.addEventListener('change', function () {
            currentTypeFilter = this.value;
            applyFilters();
        });

        statusFilter.addEventListener('change', function () {
            currentStatusFilter = this.value;
            applyFilters();
        });

        clearFiltersBtn.addEventListener('click', function () {
            typeFilter.value = 'all';
            statusFilter.value = 'all';
            currentTypeFilter = 'all';
            currentStatusFilter = 'all';
            searchInput.value = '';
            applyFilters();
        });

        // Add the refund status filter listener here:
        document.getElementById('refund-status-filter').addEventListener('change', function () {
            currentRefundStatusFilter = this.value;
            applyRefundFilters();
        });

        viewModal.addEventListener('click', (e) => {
            if (e.target === viewModal) {
                closeModalFn();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && viewModal.classList.contains('active')) {
                closeModalFn();
            }
        });

        document.addEventListener('DOMContentLoaded', loadBookings);

        let revenueChart, ticketTypesChart, statusChart, visitorsChart, eventTicketsChart, busiestTimesChart;
        let currentRevenuePeriod = 'day';

        window.changeRevenuePeriod = function (period) {
            currentRevenuePeriod = period;

            document.querySelectorAll('.chart-btn[data-period]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.chart-btn[data-period="${period}"]`).classList.add('active');

            initializeRevenueChart();
        }

        function initializeRevenueChart() {
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            let labels = [];
            let data = [];

            if (currentRevenuePeriod === 'day') {
                const revenueByDay = {};
                const last30Days = [];
                const today = new Date();

                for (let i = 29; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dayKey = date.toISOString().split('T')[0];
                    last30Days.push(dayKey);
                    revenueByDay[dayKey] = 0;
                }

                allBookings.forEach(booking => {
                    if (booking.purchaseDate) {
                        const date = booking.purchaseDate.toDate ? booking.purchaseDate.toDate() : new Date(booking.purchaseDate);
                        const dayKey = date.toISOString().split('T')[0];
                        if (revenueByDay.hasOwnProperty(dayKey)) {
                            revenueByDay[dayKey] += (booking.totalPrice || 0);
                        }
                    }
                });

                labels = last30Days.map(d => {
                    const date = new Date(d);
                    return `${date.getMonth() + 1}/${date.getDate()}`;
                });
                data = last30Days.map(d => revenueByDay[d]);

            } else if (currentRevenuePeriod === 'month') {
                const revenueByMonth = {};
                allBookings.forEach(booking => {
                    if (booking.purchaseDate) {
                        const date = booking.purchaseDate.toDate ? booking.purchaseDate.toDate() : new Date(booking.purchaseDate);
                        const monthYear = `${date.getMonth() + 1}/${date.getFullYear()}`;
                        revenueByMonth[monthYear] = (revenueByMonth[monthYear] || 0) + (booking.totalPrice || 0);
                    }
                });

                const sortedMonths = Object.keys(revenueByMonth).sort((a, b) => {
                    const [m1, y1] = a.split('/').map(Number);
                    const [m2, y2] = b.split('/').map(Number);
                    return y1 === y2 ? m1 - m2 : y1 - y2;
                });

                labels = sortedMonths;
                data = sortedMonths.map(m => revenueByMonth[m]);

            } else if (currentRevenuePeriod === 'year') {
                const revenueByYear = {};
                allBookings.forEach(booking => {
                    if (booking.purchaseDate) {
                        const date = booking.purchaseDate.toDate ? booking.purchaseDate.toDate() : new Date(booking.purchaseDate);
                        const year = date.getFullYear().toString();
                        revenueByYear[year] = (revenueByYear[year] || 0) + (booking.totalPrice || 0);
                    }
                });

                const sortedYears = Object.keys(revenueByYear).sort();
                labels = sortedYears;
                data = sortedYears.map(y => revenueByYear[y]);
            }

            if (revenueChart) revenueChart.destroy();
            revenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Revenue ($)',
                        data: data,
                        borderColor: '#653025',
                        backgroundColor: 'rgba(101, 48, 37, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function initializeCharts() {
            initializeRevenueChart();

            const ticketTypesCtx = document.getElementById('ticketTypesChart').getContext('2d');
            const generalCount = allBookings.filter(b => b.ticketType === 'general').length;
            const eventCount = allBookings.filter(b => b.ticketType === 'event').length;

            if (ticketTypesChart) ticketTypesChart.destroy();
            ticketTypesChart = new Chart(ticketTypesCtx, {
                type: 'doughnut',
                data: {
                    labels: ['General Visit', 'Event'],
                    datasets: [{
                        data: [generalCount, eventCount],
                        backgroundColor: ['#856A41', '#3781BF'],
                        borderWidth: 2,
                        borderColor: '#fdfaf4'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            const statusCtx = document.getElementById('statusChart').getContext('2d');
            const confirmedCount = allBookings.filter(b => b.status === 'confirmed').length;
            const cancelledCount = allBookings.filter(b => b.status === 'cancelled').length;

            if (statusChart) statusChart.destroy();
            statusChart = new Chart(statusCtx, {
                type: 'pie',
                data: {
                    labels: ['Confirmed', 'Cancelled'],
                    datasets: [{
                        data: [confirmedCount, cancelledCount],
                        backgroundColor: ['#45BA76', '#f56565'],
                        borderWidth: 2,
                        borderColor: '#fdfaf4'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            const visitorsCtx = document.getElementById('visitorsChart').getContext('2d');
            let totalAdults = 0, totalSeniors = 0, totalChildren = 0;
            allBookings.forEach(booking => {
                totalAdults += booking.visitors?.adults?.count || 0;
                totalSeniors += booking.visitors?.seniors?.count || 0;
                totalChildren += booking.visitors?.children?.count || 0;
            });

            if (visitorsChart) visitorsChart.destroy();
            visitorsChart = new Chart(visitorsCtx, {
                type: 'bar',
                data: {
                    labels: ['Adults', 'Seniors', 'Children'],
                    datasets: [{
                        label: 'Visitor Count',
                        data: [totalAdults, totalSeniors, totalChildren],
                        backgroundColor: ['#b08d57', '#8b1a1a', '#4299e1'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            const eventTicketsCtx = document.getElementById('eventTicketsChart').getContext('2d');
            const eventBookings = allBookings.filter(b => b.ticketType === 'event');
            const eventTicketCounts = {};

            eventBookings.forEach(booking => {
                const eventName = booking.eventName || 'Unknown Event';
                eventTicketCounts[eventName] = (eventTicketCounts[eventName] || 0) + 1;
            });

            const eventNames = Object.keys(eventTicketCounts);
            const eventCounts = Object.values(eventTicketCounts);

            if (eventTicketsChart) eventTicketsChart.destroy();
            eventTicketsChart = new Chart(eventTicketsCtx, {
                type: 'bar',
                data: {
                    labels: eventNames.length > 0 ? eventNames : ['No Events'],
                    datasets: [{
                        label: 'Tickets Sold',
                        data: eventCounts.length > 0 ? eventCounts : [0],
                        backgroundColor: '#3781BF',
                        borderWidth: 0
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });

            const busiestTimesCtx = document.getElementById('busiestTimesChart').getContext('2d');
            const timeSlots = {
                '9:00 AM': 0, '10:00 AM': 0, '11:00 AM': 0, '12:00 PM': 0,
                '1:00 PM': 0, '2:00 PM': 0, '3:00 PM': 0, '4:00 PM': 0, '5:00 PM': 0
            };

            allBookings.forEach(booking => {
                const visitTime = booking.visitTime;
                if (visitTime) {
                    if (visitTime.includes('9')) timeSlots['9:00 AM']++;
                    else if (visitTime.includes('10')) timeSlots['10:00 AM']++;
                    else if (visitTime.includes('11')) timeSlots['11:00 AM']++;
                    else if (visitTime.includes('12')) timeSlots['12:00 PM']++;
                    else if (visitTime.includes('1') || visitTime.includes('13')) timeSlots['1:00 PM']++;
                    else if (visitTime.includes('2') || visitTime.includes('14')) timeSlots['2:00 PM']++;
                    else if (visitTime.includes('3') || visitTime.includes('15')) timeSlots['3:00 PM']++;
                    else if (visitTime.includes('4') || visitTime.includes('16')) timeSlots['4:00 PM']++;
                    else if (visitTime.includes('5') || visitTime.includes('17')) timeSlots['5:00 PM']++;
                }
            });

            if (busiestTimesChart) busiestTimesChart.destroy();
            busiestTimesChart = new Chart(busiestTimesCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(timeSlots),
                    datasets: [{
                        label: 'Bookings',
                        data: Object.values(timeSlots),
                        backgroundColor: '#856A41',
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }


        let allRefunds = [];
        let filteredRefunds = [];
        let currentRefundStatusFilter = 'all';

        // Update the stats function to include pending refunds
        const pendingRefunds = allRefunds.filter(r => r.refundStatus === 'pending').length;
        document.getElementById('pending-refunds').textContent = pendingRefunds;

        // Render Refunds Table
        function renderRefundsTable(refundsList) {
            const refundsLoading = document.getElementById('refunds-loading');
            const refundsTbody = document.getElementById('refunds-tbody');
            const refundsTable = document.getElementById('refunds-table');
            const refundsEmptyState = document.getElementById('refunds-empty-state');

            refundsLoading.style.display = 'none';
            refundsTbody.innerHTML = '';

            if (refundsList.length === 0) {
                refundsTable.style.display = 'none';
                refundsEmptyState.style.display = 'block';
                return;
            }

            refundsTable.style.display = 'table';
            refundsEmptyState.style.display = 'none';

            refundsList.forEach((refund) => {
                const eventInfo = refund.ticketType === 'event'
                    ? refund.eventName || 'Event Ticket'
                    : 'General Visit';

                const paymentMethod = refund.paymentDetails?.method
                    ? `${refund.paymentDetails.method.charAt(0).toUpperCase() + refund.paymentDetails.method.slice(1)}${refund.paymentDetails.cardLastFour ? ' ****' + refund.paymentDetails.cardLastFour : ''}`
                    : 'N/A';

                const reason = refund.cancellationReason === 'event_cancelled'
                    ? 'Event Cancelled'
                    : 'Customer Request';

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>
                <code style="background: var(--neutral-light); padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.85rem;">${refund.id.substring(0, 12)}...</code>
            </td>
            <td>
                <div style="font-weight: 600;">${refund.userName || 'N/A'}</div>
                <div style="font-size: 0.85rem; color: var(--text-light);">${refund.userEmail || 'N/A'}</div>
            </td>
            <td>
                <div style="font-weight: 600;">${eventInfo}</div>
                <div style="font-size: 0.85rem; color: var(--text-light);">${refund.ticketType === 'event' ? 'Event' : 'General'}</div>
            </td>
            <td>
                <div class="date-cell">${formatTimestamp(refund.cancelledAt)}</div>
                <div style="font-size: 0.8rem; color: var(--text-light);">By: ${refund.cancelledBy || 'Admin'}</div>
            </td>
            <td>
                <div class="price-cell">$${(refund.refundAmount || 0).toFixed(2)}</div>
                <div style="font-size: 0.8rem; color: var(--text-light);">${refund.currency || 'USD'}</div>
            </td>
            <td>${paymentMethod}</td>
            <td>
                <span style="font-size: 0.85rem; font-weight: 500;">${reason}</span>
            </td>
            <td>
                <span class="status-badge status-${refund.refundStatus || 'pending'}">${(refund.refundStatus || 'pending').charAt(0).toUpperCase() + (refund.refundStatus || 'pending').slice(1)}</span>
            </td>
            <td>
                <div class="action-buttons">
                    <button class="btn-icon btn-refund" data-id="${refund.id}" data-status="${refund.refundStatus || 'pending'}" title="Update Refund Status">
                        <span class="material-icons" style="font-size: 1.2rem;">edit</span>
                    </button>
                </div>
            </td>
        `;
                refundsTbody.appendChild(row);
            });

            document.querySelectorAll('.btn-refund').forEach(btn => {
                btn.addEventListener('click', handleRefundStatusChange);
            });
        }

        // Apply Refund Filters
        function applyRefundFilters() {
            let refunds = [...allRefunds];

            if (currentRefundStatusFilter !== 'all') {
                refunds = refunds.filter(r => r.refundStatus === currentRefundStatusFilter);
            }

            filteredRefunds = refunds;
            renderRefundsTable(filteredRefunds);
        }

        // Handle Refund Status Change
        async function handleRefundStatusChange(e) {
            const refundId = e.currentTarget.getAttribute('data-id');
            const currentStatus = e.currentTarget.getAttribute('data-status');
            const refund = allRefunds.find(r => r.id === refundId);

            if (!refund) return;

            const statusOptions = `
        <select id="new-refund-status" class="filter-select" style="width: 100%; margin: 1rem 0;">
            <option value="pending" ${currentStatus === 'pending' ? 'selected' : ''}>Pending</option>
            <option value="processing" ${currentStatus === 'processing' ? 'selected' : ''}>Processing</option>
            <option value="completed" ${currentStatus === 'completed' ? 'selected' : ''}>Completed</option>
            <option value="failed" ${currentStatus === 'failed' ? 'selected' : ''}>Failed</option>
        </select>
    `;

            const confirmed = await showCustomAlert({
                type: 'info',
                icon: 'edit',
                title: 'Update Refund Status',
                subtitle: `Booking ID: ${refundId.substring(0, 12)}...`,
                body: `
            <p><strong>Customer:</strong> ${refund.userName}</p>
            <p><strong>Amount:</strong> $${(refund.refundAmount || 0).toFixed(2)}</p>
            <p><strong>Current Status:</strong> ${currentStatus.charAt(0).toUpperCase() + currentStatus.slice(1)}</p>
            <hr style="margin: 1rem 0; border: none; border-top: 1px solid var(--neutral-light);">
            <label style="font-weight: 600; display: block; margin-bottom: 0.5rem;">New Status:</label>
            ${statusOptions}
        `,
                buttons: [
                    { text: 'Cancel', type: 'secondary', value: false },
                    { text: 'Update Status', type: 'primary', value: true, icon: 'check' }
                ]
            });

            if (!confirmed) return;

            const newStatus = document.getElementById('new-refund-status').value;

            if (newStatus === currentStatus) {
                await showErrorAlert('No Change', 'The status was not changed.');
                return;
            }

            try {
                await updateDoc(doc(db, "Ticketing", refundId), {
                    refundStatus: newStatus,
                    refundStatusUpdatedAt: serverTimestamp(),
                    refundStatusUpdatedBy: auth.currentUser?.email || 'Admin'
                });

                await logActivity('refund', 'status_updated', `${refund.userName} - ${refund.eventName || 'General Visit'}`, {
                    bookingId: refundId,
                    oldStatus: currentStatus,
                    newStatus: newStatus,
                    refundAmount: refund.refundAmount
                });

                await showSuccessAlert(
                    'Refund Status Updated',
                    `Refund status changed from <strong>${currentStatus}</strong> to <strong>${newStatus}</strong>.`
                );

            } catch (error) {
                console.error("âŒ Error updating refund status:", error);
                await showErrorAlert(
                    'Failed to Update Status',
                    `An error occurred: ${error.message}`
                );
            }
        }
    </script>
    <script src="cache-helper.js"></script>

</body>

</html>